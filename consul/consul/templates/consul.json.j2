{% set consul_addr = hostvars[inventory_hostname]['ansible_'~consul_advertise_iface]['ipv4']['address'] %}
{% set consul_join_addrs = groups['all'] | map('extract', hostvars, ['ansible_'~consul_advertise_iface, 'ipv4', 'address']) | list %}
{
  "server": {{ "true" if consul_is_server else "false"}},
  "domain": "consul.",
  "data_dir": "{{ consul_home }}/data",
  "bind_addr": "{{ consul_addr }}",
  "advertise_addr": "{{ consul_addr }}",
  "retry_join": [ "{{ consul_join_addrs | difference(consul_addr) | join('", "') }}" ],
  "bootstrap_expect": {{ consul_join_addrs | length }},
  "addresses": {
    "https": "{{ consul_addr }}"
  },
  "ports": {
    "https": 8500
  },
  "encrypt": "{{ consul_encrypt }}",
  "ca_file": "{{ consul_home }}/secrets/miguelaco.crt",
  "key_file": "{{ consul_home }}/secrets/server.dc1.consul.key.pem",
  "cert_file": "{{ consul_home }}/secrets/server.dc1.consul.cert.pem",
  "verify_outgoing": true,
  "verify_server_hostname": true,
  "acl_datacenter": "dc1",
  "acl_default_policy": "deny",
  "acl_down_policy": "deny",
  "acl_master_token": "{{ consul_acl_master_token }}",
  "acl_agent_token": "{{ consul_acl_agent_token }}"
}