---

- block:
  - name: Create consul group
    group: name=consul system=yes

  - name: Create consul user
    user:
      name=consul
      group=consul
      system=yes

  - name: Create consul directory
    file:
      path: "{{ item }}"
      state: directory
      owner: consul
      group: consul
      mode: 0755
    with_items:
      - "{{ consul_home }}"
      - "{{ consul_home }}/bin"
      - "{{ consul_home }}/data"
      - "{{ consul_config_dir }}"

  - name: Create consul init directory
    local_action: file path={{ consul_init_dir }} state=directory
    become: no
    run_once: yes

  - name: Check consul package
    local_action:
      stat
        path={{ role_path }}/files/consul_{{ consul_version }}_linux_amd64.zip
    become: no
    run_once: yes
    register: consul_package

  - name: Download consul package locally
    local_action:
      get_url
        url=https://releases.hashicorp.com/consul/{{ consul_version }}/consul_{{ consul_version }}_linux_amd64.zip
        dest={{ role_path }}/files
        force=no
    become: no
    run_once: yes
    when: not consul_package.stat.exists

  - package: name=unzip state=present

  - name: Copy consul package to hosts
    unarchive:
      src={{ role_path }}/files/consul_{{ consul_version }}_linux_amd64.zip
      dest={{ consul_home }}/bin
    notify:
      - Start consul service

  - name: Check encrypt file
    local_action: stat path={{ consul_init_dir }}/encrypt
    register: encrypt_file
    run_once: yes
    become: no

  - name: Generate encryption key
    command: "{{ consul_home }}/bin/consul keygen"
    register: keygen
    run_once: yes
    when: not encrypt_file.stat.exists

  - name: Save encryption key
    local_action:
      copy
      content={{ keygen.stdout }}
      dest={{ consul_init_dir }}/encrypt
    become: no
    run_once: yes
    when: not encrypt_file.stat.exists

  - name: Lookup encrypt file
    set_fact:
      consul_encrypt: "{{ lookup('file', '{{ consul_init_dir }}/encrypt') }}"
    no_log: yes

  - name: Check acl_agent_token file
    local_action: stat path={{ consul_init_dir }}/acl_agent_token
    register: acl_agent_token_file
    run_once: yes
    become: no

  - name: Lookup acl_agent_token file
    set_fact:
      acl_agent_token: "{{ lookup('file', '{{ consul_init_dir }}/acl_agent_token') }}"
    no_log: yes
    when: acl_agent_token_file.stat.exists

  - name: Copy consul config file
    template:
      src={{ item.src }}
      dest={{ item.dest }}
      owner=consul
      group=consul
      mode={{ item.mode }}
    with_items:
      - { src: "consul.json.j2", dest: "{{ consul_config_file }}", mode: "0600" }
      - { src: "consul.systemd.j2", dest: "/etc/systemd/system/consul.service", mode: "0644" }
    notify:
      - Start consul service

  - name: Set consul env variables
    template:
      src=templates/consul.sh.j2
      dest=/etc/profile.d/consul.sh
      owner=consul
      group=consul

- always:
  - meta: flush_handlers

- block:
  - name: Bootstrap ACL system
    uri:
      url: http://127.0.0.1:8500/v1/acl/bootstrap
      method: PUT
      status_code: 200, 403
    register: root_token
    no_log: no
    run_once: true

  - name: Save consul root_token
    local_action:
      copy
        content={{ root_token.json.ID }}
        dest={{ consul_init_dir }}/root_token
    become: no
    run_once: yes
    when: root_token.status == 200 and root_token.json

  - name: Lookup root_token file
    set_fact:
      consul_root_token: "{{ lookup('file', '{{ consul_init_dir }}/root_token') }}"
    no_log: yes

  - name: Create agent ACL
    uri:
      url: http://127.0.0.1:8500/v1/acl/create
      method: PUT
      headers:
        X-Consul-Token: "{{ consul_root_token }}"
      body_format: json
      body:
        Name: acl_agent_token
        Type: client
        Rules: "node \"\" { policy = \"write\" } service \"\" { policy = \"read\" }"
    register: acl_agent_token_response
    no_log: yes
    when: acl_agent_token is undefined
    run_once: true

  - name: Update agent ACL
    uri:
      url: http://127.0.0.1:8500/v1/acl/update
      method: PUT
      headers:
        X-Consul-Token: "{{ consul_root_token }}"
      body_format: json
      body:
        Id: "{{ acl_agent_token }}"
        Name: acl_agent_token
        Type: client
        Rules: "node \"\" { policy = \"write\" } service \"\" { policy = \"read\" }"
    no_log: yes
    when: acl_agent_token is defined
    run_once: true

  - name: Save acl_agent_token
    local_action:
      copy
        content={{ acl_agent_token_response.json.ID }}
        dest={{ consul_init_dir }}/acl_agent_token
    become: no
    run_once: yes
    when: acl_agent_token is undefined

  - name: Lookup acl_agent_token file
    set_fact:
      acl_agent_token: "{{ lookup('file', '{{ consul_init_dir }}/acl_agent_token') }}"
    no_log: yes
    when: acl_agent_token is undefined

  - name: Copy consul config file
    template:
      src=consul.json.j2
      dest={{ consul_config_file }}
      owner=consul
      group=consul
      mode=0600
    when: acl_agent_token_response is not skipped
    notify:
      - Start consul service

  - name: Anonymous ACL
    uri:
      url: http://127.0.0.1:8500/v1/acl/update
      method: PUT
      headers:
        X-Consul-Token: "{{ consul_root_token }}"
      body_format: json
      body:
        Id: anonymous
        Name: Anonymous Token
        Type: client
        Rules: "node \"\" { policy = \"read\" } service \"\" { policy = \"read\" }"
    run_once: true

- always:
  - meta: flush_handlers
